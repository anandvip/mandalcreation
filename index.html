<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mandal Management System</title>
    <style>
        body {
            background-image: url('https://source.unsplash.com/random');
            background-size: cover;
            background-position: center;
        }
        #myDialog {
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
        }
        .dialog-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 15px;
            max-width: 80%;
            text-align: center;
        }
        .mandal-button {
            padding: 10px 20px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .close, .toast-close {
            color: #000;
            float: right;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: none; /* Initially hidden */
        }
        .toast {
            padding: 10px 20px;
            background-color: #333;
            color: white;
            border-radius: 5px;
            text-align: center;
            position: relative;
        }
        .existing-mandal {
            padding: 50px;
          width:fit-content;
            margin-top: 20px;
            background-color: lightgray;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="grid-container">
        <div class="mandal-heading"><h1>Mandal Name Here</h1></div>
        <div id="existingMandalCard" class="existing-mandal"></div>
        <div class="card">
            <div class="button-container">
                <button class="mandal-button" onclick="openDialog()">Mandal Creation</button>
            </div>
            <div id="myDialog" class="dialog" aria-labelledby="myDialogTitle" aria-hidden="true">
                <div class="dialog-content">
                    <span class="close" onclick="closeDialog()">ⓧ</span>
                    <form id="mandalForm">
                        <input type="text" id="userName" placeholder="Your Name">
                        <input type="text" id="mandalName" placeholder="Mandal Focus or Intention">
                        <input type="date" id="startDate" placeholder="Start Date">
                        <select id="mandalDuration">
                            <option value="48">48 days (96 sessions)</option>
                            <option value="90">90 days (1 session/day)</option>
                        </select>
                        <button type="button" onclick="saveMandal()">Save Mandal</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="toastContainer" class="toast-container">
        <div id="toastMessage" class="toast">
            <span class="toast-close" onclick="hideToast()">×</span>
        </div>
    </div>
    <script>
        var sessionCreationUrl = "https://anandvip.github.io/mandalapp-2/";  // Placeholder URL

        window.addEventListener('load', function() {
            checkAndDisplayExistingMandal();
        });

        function openDialog() {
            document.getElementById("myDialog").style.display = "flex";
            document.getElementById("mandalForm").classList.remove('hidden');
        }

        function closeDialog() {
            document.getElementById("myDialog").style.display = "none";
        }

        function saveMandal() {
            const userName = document.getElementById('userName').value;
            const mandalName = document.getElementById('mandalName').value;
            const startDate = new Date(document.getElementById('startDate').value);
            const mandalDuration = document.getElementById('mandalDuration').value;
            const endDate = new Date(startDate.getTime() + parseInt(mandalDuration) * 24 * 60 * 60 * 1000);

            const mandal = {
                userName,
                name: mandalName,
                duration: mandalDuration,
                creationDate: startDate.toDateString(),
                endDate: endDate.toDateString(),
            };

            let mandals = JSON.parse(localStorage.getItem('mandalProgress')) || [];
            mandals.push(mandal);
            localStorage.setItem('mandalProgress', JSON.stringify(mandals));
            localStorage.setItem('username', userName); // Save the user's name separately if needed

            updateHeader(mandalName); 
            checkAndDisplayExistingMandal();
            showToast(`Mandal created successfully! It starts on ${startDate.toDateString()} and ends on ${endDate.toDateString()}.`);
            closeDialog();
        }

        function updateHeader(name) {
            const header = document.querySelector('.mandal-heading h1');
            header.textContent = `Mandal: ${name}`;
        }

        function showToast(message) {
            const toastContainer = document.getElementById('toastContainer');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.innerHTML = `${message} <a href="${sessionCreationUrl}" style="color: yellow;">Click here</a> to start creating meditation sessions.<span class="toast-close" onclick="hideToast()">×</span>`;
            toastContainer.style.display = 'block';
        }

        function hideToast() {
            document.getElementById('toastContainer').style.display = 'none';
        }

        function checkAndDisplayExistingMandal() {
            const username = localStorage.getItem('username');
            const mandals = JSON.parse(localStorage.getItem('mandalProgress'));
            const meditationHistory = JSON.parse(localStorage.getItem('meditationHistory'));

            if (username && mandals && mandals.length > 0) {
                const lastMandal = mandals[mandals.length - 1];
                const mandalDaysCompleted = (meditationHistory && meditationHistory[lastMandal.name]) ? meditationHistory[lastMandal.name].length : 0;
                const remainingDays = lastMandal.duration - mandalDaysCompleted;
                
                const existingMandalCard = document.getElementById('existingMandalCard');
                existingMandalCard.innerHTML = `
                    <h3>Existing Mandal Found</h3>
                    <p>Username: ${username}</p>
                    <p>Mandal Name: ${lastMandal.name}</p>
                    <p>Start Date: ${lastMandal.creationDate}</p>
                    <p>End Date: ${lastMandal.endDate}</p>
                    <p>Days Completed: ${mandalDaysCompleted}</p>
                    <p>${remainingDays > 0 ? `Remaining Days: ${remainingDays}` : "Mandal Completed. You can create a new one."}</p>
                `;
                existingMandalCard.style.display = 'block';
            }
        }
      function checkAndDisplayExistingMandal() {
    const username = localStorage.getItem('username');
    const mandals = JSON.parse(localStorage.getItem('mandalProgress'));

    if (username && mandals && mandals.length > 0) {
        const lastMandal = mandals[mandals.length - 1];
        const startDate = new Date(lastMandal.creationDate);
        const endDate = new Date(lastMandal.endDate);
        const currentDate = new Date();

        // Calculate days completed and remaining days
        const daysCompleted = Math.floor((Math.min(currentDate, endDate) - startDate) / (1000 * 60 * 60 * 24));
        const remainingDays = Math.max(0, Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24)));

        const existingMandalCard = document.getElementById('existingMandalCard');
        existingMandalCard.innerHTML = `
            <h3>Existing Mandal Found</h3>
            <p>Username: ${username}</p>
            <p>Mandal Name: ${lastMandal.name}</p>
            <p>Start Date: ${startDate.toDateString()}</p>
            <p>End Date: ${endDate.toDateString()}</p>
            <p>Days Completed: ${daysCompleted}</p>
            <p>${remainingDays > 0 ? `Remaining Days: ${remainingDays}` : "Mandal Completed. You can create a new one."}</p>
        `;
        existingMandalCard.style.display = 'block';
        updateHeader(lastMandal.name); // Ensure the header is updated with the current Mandal name
    } else {
        showToast("No existing Mandal found. Please create one by selecting a card.");
    }
}

function updateHeader(name) {
    const header = document.querySelector('.mandal-heading h1');
    header.textContent = `Mandal: ${name}`;
}

function showToast(message) {
    const toastContainer = document.getElementById('toastContainer');
    const toastMessage = document.getElementById('toastMessage');
    toastMessage.innerHTML = message;
    toastContainer.style.display = 'block';
    setTimeout(() => {
        toastContainer.style.display = 'none';
    }, 5000);
}

    </script>
</body>
</html>
